{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block nav %}
{% include "base_nav.html" %}
{% endblock nav %}
{% block content%}
<br>
<br>
<div class="container col-md-10"
    style="background-color: #FFFFFF; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19); border-radius: 15px;">
    <br>
    <h2 style="text-align: center;">Post AD</h2>
    <br>
    <div class="alert col-md-10" style="margin:auto;">
        <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
        <a href="{% url 'mechanics:create' %}" style="color: #000000 !important;">Post mechanic/garage
            instead?</a>
    </div>
    <br>
    <form method="post" enctype="multipart/form-data" class="col-md-10"
        style="margin-left: auto; margin-right: auto; display: block;">
        {% csrf_token %}
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.name|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.photo|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.category|as_crispy_field }}
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    {{ form.sub_category|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.car_make|as_crispy_field }}
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    {{ form.car_model|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.condition|as_crispy_field }}
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    {{ form.year_of_manufacture|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="form-group">
                    {{ form.description|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.price|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    {{ form.phone_number|as_crispy_field }}
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    {{ form.location|as_crispy_field }}
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-light col-md-6"
            style="background-color:#0f172e !important; color:white; margin-left: auto; margin-right: auto; display: block;">Post
            AD</button>
    </form>
    <br>
</div>
<br>

<script>
    const categoryInput = document.querySelector("select#id_category")
    const subcategoryInput = document.querySelector("select#id_sub_category")

    categoryInput.onchange = function (e) {
        getAndSetSubcategories(e.target.value)
    }

    function getAndSetSubcategories(category) {
        let subCatReq = new XMLHttpRequest()

        subCatReq.addEventListener("load", function (e) {
            let subcategories = JSON.parse(e.target.response)

            // Map the list of subcategory objects to a list of options
            subcategories = subcategories.map(function (subcategory) {
                return `<option value="${subcategory.pk}">${subcategory.fields.name}</option>`
            })

            // Add default option to start of the array
            subcategories.splice(0, 0, '<option value="" selected="">---------</option>')

            subcategoryInput.innerHTML = subcategories.join(" ")
        })

        subCatReq.open("GET", `{% url 'sparedealers:get_subcategories' %}?category=${category}`)
        subCatReq.send()
    }

    // Get car model car_make == category
    const car_makeInput = document.querySelector("select#id_car_make")
    const car_modelInput = document.querySelector("select#id_car_model")

    car_makeInput.onchange = function (e) {
        getAndSetCarmodels(e.target.value)
    }

    function getAndSetCarmodels(car_make) { //subCatReg == carmodelReq
        let carModelReq = new XMLHttpRequest()

        carModelReq.addEventListener("load", function (e) { //subcategories ==car_models
            let car_models = JSON.parse(e.target.response)

            // Map the list of subcategory objects to a list of options
            subcategories = car_models.map(function (car_model) {
                return `<option value="${car_model.pk}">${car_model.fields.name}</option>`
            })

            // Add default option to start of the array
            car_models.splice(0, 0, '<option value="" selected="">---------</option>')

            car_modelInput.innerHTML = subcategories.join(" ")
        })

        carModelReq.open("GET", `{% url 'carowners:get_carmodels' %}?car_make=${car_make}`)
        carModelReq.send()
    }
</script>

{% endblock %}
{% block footer %}
{% endblock %}